name: CI

on:
  workflow_call:

jobs:
  build-container:
    runs-on: cluster0-nxcp-runner
    container: gcr.io/kaniko-project/executor:v1.9.0-debug
    steps:
      - name: kaniko
        run: |
            mkdir -p /kaniko/.docker
            pwd
            ls -l
            # Add dev auth
            echo -e '{"auths":{"${{needs.setenv.outputs.harbor_registry}}":{"username":"${{needs.setenv.outputs.harbor_user}}","password":"${{needs.setenv.outputs.harbor_pass}}"}}}' > /kaniko/.docker/config.json
            cat /kaniko/.docker/config.json
            /kaniko/executor --context "$(pwd)" --dockerfile "Dockerfile" --destination "${{needs.setenv.outputs.harbor_registry}}/cluster0/tks-console:${{needs.setenv.outputs.tag_name}}"  --build-arg GIT_USER=github-ci-token --build-arg GIT_PASS=${{needs.setenv.outputs.git_token}}